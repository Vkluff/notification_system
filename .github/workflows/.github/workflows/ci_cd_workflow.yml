# .github/workflows/ci_cd_workflow.yml

name: CI/CD Pipeline for Notification System

on:
  push:
    branches:
      - main # This workflow runs whenever you push code to the 'main' branch
  pull_request:
    branches:
      - main # This workflow runs whenever a Pull Request is opened against 'main'

jobs:
  build_and_test:
    runs-on: ubuntu-latest # Use a standard Linux runner provided by GitHub

    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # Downloads your code from the repository

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3 # Sets up the tool needed to build Docker images

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }} # Reads your Docker Hub username from GitHub Secrets
          password: ${{ secrets.DOCKER_PASSWORD }} # Reads your Docker Hub password from GitHub Secrets

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: notification_system/core # Tells Docker to look inside the 'core' folder for the Dockerfile
          push: true # Pushes the image to Docker Hub
          tags: ${{ secrets.DOCKER_USERNAME }}/notification-system:latest # The name of your image

      - name: Run Tests (Placeholder)
        # In a real project, you would run your Django tests here:
        # run: docker compose run web python manage.py test
        run: echo "Tests would run here after the image is built."

  deploy:
    needs: build_and_test # This job only runs if the 'build_and_test' job was successful
    runs-on: ubuntu-latest
    environment: production # Links to a protected environment in GitHub settings
    if: github.ref == 'refs/heads/main' # Only deploy if the push was to the main branch

    steps:
      - name: Deploy to Kubernetes (Placeholder)
        # This step would contain the actual commands to deploy to your cloud provider (e.g., AWS, Google Cloud)
        run: |
          echo "Deployment to production environment initiated."
          echo "This is where you would run kubectl apply -f k8s/deployment.yaml"
          echo "Deployment successful."